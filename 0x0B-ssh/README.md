# 0x0B. SSH
``DevOps`` ``SSH`` ``Network`` ``SysAdmin`` ``Security``

## Context
#### The Server
A server is a piece of computer hardware or software (computer program) that provides functionality
for other programs or devices, called clients.

The role of a server is to share data as well as to share resources and distribute work. A Server
computer can serve its own computer program as well; depending on the scenario.

The following table shows several scenarios in which a server is used.
|Server type|Purpose|Client|
|-------------|---------|--------|
Application server | Hosts wep apps allowing users in the network to run and use them, without having to install a copy on their own computers. These servers do not need to be part of the www; any local network would do | Computers with a web browser
Communications server | Maintains an environment needed for one communication endpoint to find other endpoints and communicate with them. | Communication endpoints (users or devices)
Database server | Maintains and shares any form of database over a network | Spreadsheets, accounting software or virutally any computer program that consumes well-organized data, especially in large volumes
File server | Shares files and folders, storage space to hold files and/or folder over network | Networked computers are the intended clients, even though local programs can be clients
Proxy server | Acts as an intermediary between a client and a server, accepting incoming traffic from the client and sending it to the server. Reasons for doing so include content control and filtering, improving traffic performance, preventing unauthorized network access or simply routing the traffic over a large and complex network | Any network computer
Virtual server | Shares hardware and software resources with other virtual servers. It exists only as defined within specialized software called hypervisor | Any networked computer
Web server | Hosts web pages. A web server is what make the World Wide Web possible | Computers with a web browser

#### SSH
**Introduction** <br/>
SSH is a secure protocol used as the primary means of connecting to Linux servers remotely. After connecting, all commands you type in your local terminal are sent to the remote server and executed there.<br/>
This software listens for connections on a specific network port, authenticates connection requests, and spawns the appropriate environment if the user provides the correct credentials.<br/>
SSH was build as a replacement for telnet (which can almost do all that SSH does but is not secured).

**How SSH Authenticates Users**<br/>
Clients generally authenticate either using passwords (less secure and not recommended) or SSH keys (ie. matching set of cryptograhic keys), which are very secure.<br/>
Each set of SSH keys contains a public (.pub) and private. The .pub can be shared freely without concern, while the private key guarded and never exposed to anyone.<br/>
To authenticate using SSH keys, a user must have an SSH key pair on their local computer and the public key copied to a file (~/.ssh/authorized_keys) on the remote server. This file contains a list of public keys, one-per-line, that are authorized to log into the account.

When a client connects to the host, wishing to use SSH key authentication, it will inform the server of this intent and will tell the server which public key to use. The server then checks its authorized_keys file for the public key, generates a random string, and encrypts it using the public key. This encrypted message can only be decrypted with the associated private key. The server will send this encrypted message to the client to test whether they actually have the associated private key.<br/>
Upon receipt of this message, the client will decrypt it using the private key and combine the random string that is revealed with a previously negotiated session ID. It then generates an MD5 hash of this value and transmits it back to the server. The server already had the original message and the session ID, so it can compare an MD5 hash generated by those values and determine that the client must have the private key.

**Generating an SSH Key Pair**
A number of cryptographic algorithms can be used to generate SSH keys, including: RSA, DSA, and ECDSA. RSA keys are generally preferred and are the default key type.<br/>
To generate an RSA key pair on your local computer, type: ``ssh-keygen``<br/>
SSH keys are 2048 bits by default, for greater number of bit for a more hardened key use -b flag:
```
ssh-keygen -b 4096
```
To change or remove the passphrase, use -p flag ``ssh-keygen -p``<br/>
To display ssh key fingerprint (a unique key identifier), use -l flag.<br/>
Copying Public SSH key to a Server Without SSH-Copy-ID:
```
cat ~/.ssh/id_rsa.pub | ssh ``username``@``remote_host`` "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
```
To run a single command on a remote server without spawning a shell session:
```
ssh ``username``@``remote_host`` ``command_to_run``
```
login in with a different port: ``ssh -p port_num username@remote_host``. To avoid doing this all the time, you can create a configuration file in the ``~/.ssh`` of your local computer (ie. ``nano ~/.ssh/config``)
```
HOST ``remote_alias``
	HostName ``remote_host``
	Port ``port_num``
```

To avoid having to repeatedly enter passphrase, run SSH agent which stores the private key after you have entered the passphrase for the first time. Hence allowing you to connect in the future without re-entering the passphrase. It is also important if you need to forward your SSH credentials.<br/>
To start the agent program and place it into the background: ``eval $(ssh-agent)``<br/>
To add the private key to the agent: ``ssh-add``

To disable password Authentication: connect to the remote server and ``sudo nano /etc/ssh/sshd_config`` file, set ``passwordAuthentication no``. To implement the changes ``sudo service ssh restart``. Now, all accounts on the system will be unable to log in with SSH using passwords.

To change the SSH listening port, connect to the romote server and ``sudo nano /etc/ssh/sshd_config`` commenting out the Port ``22`` and adding Port ``4444``. Remember to implement changes.

With ``AllowUsers user1 user2`` we limit the number of Users who can connect through ssh
With ``AllowGroups sshmembers`` we define which group have access. to edit these, you will have to open the ssh daemon config file and implement changes after completion.

**Client-Side Configuration Options**<br/>
You can define any of the directives found in the ``man ssh_config``. An example configuration would be:
```
HOST testhost
	HostName ``your_domain``
	Port ``4444``
	User demo
```
You can then connect to ``your_domain`` on port ``4444`` using the username ``demo`` by simply typing: ``ssh testhost``

You can also use wildcards to match more than one host, keeping in mind that later matches can override earlier ones. Hence, you should put your most general matches at the top.
```
HOST *
	ForwardX11 no
	ServerAliveInterval 120
	StrictHostKeyChecking no
	UserKnownHostsFile /dev/null

HOST testhost
	HostName ``your_domain``
	ForwardX11 yes
	Port ``4444``
	User ``demo``
	StrictHostKeyChecking ask
	UserKnownHostsFile /home/``demo``/.ssh/known_hosts
```

# Tasks
Task (link to task) and description in a table format
